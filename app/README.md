# BT8922颈挂式

## 固件版本：AD-BT-F0011-V1.1.5

```
v0.0.1 初始版本，算法版本v0.2.13.
v0.0.2 绿色LED，改为与蓝色交替闪.
v0.0.3 优化参数恢复存储逻辑，减少Flash擦除提高使用寿命.
v0.0.4 修复sdk中关闭提示音后，低于3.5v时，红灯不闪烁问题，开启低电红灯后关机不闪灯问题.
v0.0.5 充电满后蓝灯常亮.
v0.0.6 更新算法版本v0.2.14，优化参数存储，增加：1、每次修改参数后将自动延时10s保存，断开蓝牙连接非助听模式不保存参数，
                                             2、每次模式切换（蓝牙与助听器）会检测参数变化如音量，进行随存，
       初始设置惠州行锋耳机补偿，增加提示音功能.
       增加适配APP端模式参数下发控制，协议更新，此次版本不适配之前版本.
v0.0.7 优化提示音量过大问题，首次进入默认28级，可通过普通蓝牙模式下修改音量，只限制最低提示音等级为15级.
v0.0.8 取消按键随存，可能导致的不停重启问题，提示音默认改为等级20，最低10，修正关机中，绿灯依然闪烁问题，按键改为后置音量调节，
			 助听模式下，原开关机按键单击功能由暂停助听改为切换左右通道音量调节，带提示音，
       前置音量默认改为等级3，算法版本更新至v0.2.15修正算法降噪问题，增加安全性，增加用户层算法参数重置接口避免算法库的修改.
v0.0.9 降低参数存储由984字节降低至468字节，占用2个扇区，更快的存储速度，修复参数重参存储检测不准问题.     
v0.0.10 修复音乐状态下数据修改可能的死机重启问题，再次降低参数存储占用，468改为448字节，算法版本更新至v0.3.0.
        按键修改音量、按键修改降噪功能存储功能完善，增加退出助听模式检测参数随存.
        关闭移除充电连接后自动开机功能.
        协议更新增加获取电量.
v1.0.0 算法v0.3.1版本，32K采样率，低时延版本，降噪按键功能UI更改，单击降噪等级+，双击降噪-，长按降噪开/关. 
v1.0.1 算法v0.3.2版本，降噪按键双击功能改为切换降噪等级1 - 9循环，长按降噪按键关闭或者打开降噪功能，只切一次避免长按不停的切换.
       开关机功能键，双击改为只打开蓝牙，不关闭蓝牙，避免误操作导致关闭蓝牙误以为连不上蓝牙.
v1.0.2 算法更新至v0.3.3版本.
v1.0.4 算法更新至v0.3.5版本.
v1.0.5 修复降噪算法增加缓冲区导致的BLE数据段错误问题导致死机问题，增加测听进入退出触发保存参数，增加HW_EQ使能开关及存储.
       降噪调节范围改为1-3，音量改为0-4等级.
v1.0.6  修复驻极体MIC在使用单端内部电阻电容情况下电压提高导致电池电量测不准问题.
v1.0.7 算法更新为v0.3.6版本，优化存储crc存储在末尾，参数改变只会触发那一页的存储操作，修复恢复参数错误问题，调试端口默认打开使用PA7临时解决输入谐波问题.
			算法更新v0.3.7版本，更新通讯协议，可自由选择降噪谱.
v1.0.8 蓝牙名称更改为“爱谛声”.			
v1.0.9 修正在双核硬件下的蓝色绿色指示灯配置.
v1.1.0 协议修改，提示音可由APP端设定，范围5 - 32级，默认为5级，功能键单击改为开启蓝牙信号，音量键单击统一调节左右耳音量.
                音乐模式下，单击修改音量，长按调节歌曲切换.
                算法更新至v0.3.8版本，降噪等级 * 0.5为最终设定值.
                算法更新至v0.3.9版本，增加简易AEC啸叫抑制.
                取消软开关机功能.
v1.1.1 算法更新至v0.3.11版本，优化AEC频域算法默认等级1 - 3，默认啸叫抑制延时4s.      
v1.1.2 修复提示音量未保存问题.
v1.1.3 算法更新至v0.3.12版本.
v1.1.4 算法更新至v0.3.13版本.
v1.1.5 算法更新至v0.3.14版本.
```

版本号含义：

- AD（爱谛aids）
- BT（蓝牙功能）
- F（功能项）
- 0011（具体功能）
- V（软件版本）1.1.5

## 操作

### 蓝牙名称

**爱谛声-XXXX**

==XXXX==，为蓝牙MAC地址后四位，数值范围：0000 - FFFF

### 开关机

长按开关机键1.5秒，长按开关机键3秒

### 开关蓝牙

设备在开机后，自动打开蓝牙可被连接60s，60s过后未连接时自动关闭蓝牙，通过**双击开关机键重新打开蓝牙**

### 助听与普通蓝牙耳机模式（听歌、打电话）切换

设备在开机后，默认进入助听器模式，手机连接设备蓝牙后，便具有了普通蓝牙耳机模式，此时依然是助听器模式，当来电话、播放音乐时自动切换至普通蓝牙模式

### 按键功能预览

4个功能按键，分别用于助听器模式下与常规音乐模式下操作：

| 功能                              | 单击                                                         | 双击                                      | 长按                         |
| --------------------------------- | ------------------------------------------------------------ | ----------------------------------------- | ---------------------------- |
| 开关机键                          | 暂停歌曲并切换至助听器模式 /  蓝牙已关闭时，重新启动蓝牙60s / 来电时接通电话 / 已接听时挂断电话 |                                           | 开关机 / 来电时拒接电话      |
| 音量 - 调节/切上一曲歌            | 音量 -（最小0等级）                                          | 音量 -（最小0等级）                       | 切上一曲歌                   |
| 音量 + 调节/切下一曲歌            | 音量 +（助听下最大4等级）                                    | 音量 +（助听下最大4等级）                 | 切下一曲歌                   |
| 音量调节（重复） / 助听器降噪调节 | 歌曲音量 + / 降噪等级（1 - 3）循环切换                       | 降噪等级（1 - 3）循环切换  / 歌曲音量 + 2 | 歌曲音量 -  / 降噪开或者关闭 |



### LED

| 状态                         | LED指示                            | 备注                                  |
| ---------------------------- | ---------------------------------- | ------------------------------------- |
| 开机                         | 蓝灯快闪3次                        |                                       |
| 开机成功，蓝牙已打开但未连接 | 蓝灯持续慢闪 + 绿灯慢闪60s（交替） | 60s过后绿灯熄灭，蓝牙关闭节省电池用电 |
| 蓝牙连接成功                 | 蓝灯持续慢闪 + 绿灯熄灭            |                                       |
| 听歌中                       | 蓝灯长间隔速闪                     |                                       |
| 断开蓝牙连接                 | 蓝灯持续慢闪 + 绿灯慢闪60s（交替） |                                       |
| 低电量                       | 蓝灯 变为 红灯 持续闪              |                                       |
| 关机                         | 红灯快闪3次                        |                                       |
| 充电中                       | 红灯常量                           |                                       |
| 电量充满                     | 红灯熄灭，蓝灯常亮                 |                                       |

### 提示音

*默认中文提示*

| 状态         | 音乐指示                                 | 备注                         |
| ------------ | ---------------------------------------- | ---------------------------- |
| 开机         | POWER ON / 开机                          |                              |
| 蓝牙连接成功 | CONNECTED / 连接成功                     |                              |
| 蓝牙断开连接 | DISCONNECTED / 连接断开                  |                              |
| 低电量       | LOW BATTERY PLEASE CHARGE / 电量低请充电 | 3min 一次                    |
| 关机         | POWER OFF / 关机                         |                              |
| 助听音量调节 | 音量加 / 音量减                          |                              |
| 降噪调节     | 嘟嘟声                                   |                              |
| 音乐音量调节 | MAX VOLUME / 最大音量                    | 达到最大音量或者最小音量播报 |

提示音量调节：可在普通蓝牙模式下进行调节，即当前正在播放音乐时调节，此时设备将记住该等级，应用于播放提示音，提示音最低10级。

## APP设置助听参数

当手机蓝牙已经连接设备后，==设备必须处于助听模式==（未播放音乐、接打电话等），打开手机APP方可进行设置参数

## 助听参数存储

### 参数存储

- 当手机连接蓝牙后，断开蓝牙后触发参数存储，不可直接后台杀死程序（不能保证蓝牙断开时间点，也就是参数存储点），存储时会检测是否是助听器模式且参数是否已更新，未更新不进行存储
- 正常连接中，正在使用手机设置算法参数，设备将记录最后一次设置的时间以此延时（默认：10s）自动保存参数
- 按键下，切换通道时触发存储
- 按键下，调节音量后，紧接着调节降噪，或者调节降噪后，紧接着调节音量，触发存储
- 切换至普通蓝牙模式，立即检测触发存储
- APP下，进入测听或者退出测听模式

### 参数恢复

手机APP端设有==重置所有参数按钮==，当点击此按钮后参数即可恢复。

## 电池电量

可在APP端实时获取设备当前电量

### 电量

计算方法：level = (实测电压 - 关机电压) / ((满电电压 - 关机电压) / 10)

### 低电

满电>=4.2，低电<= 3.5v，自动关机<=3.4v

### 充电

默认以200mA充电

### 充满

充电电流小于等于2.5mA认为充满
