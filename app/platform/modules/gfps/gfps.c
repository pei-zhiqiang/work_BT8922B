#include "include.h"
#include "gfps.h"

#if GFPS_EN
//BLE PROFILE DATA
const uint8_t profile_data[] =
{
    // 0x0001 PRIMARY_SERVICE-ORG_BLUETOOTH_SERVICE_BATTERY_SERVICE
    0x0a, 0x00, 0x02, 0x00, 0x01, 0x00, 0x00, 0x28, 0x0f, 0x18,
    // 0x0002 CHARACTERISTIC-ORG_BLUETOOTH_CHARACTERISTIC_BATTERY_LEVEL-DYNAMIC | READ | NOTIFY
    0x0d, 0x00, 0x02, 0x00, 0x02, 0x00, 0x03, 0x28, 0x12, 0x03, 0x00, 0x19, 0x2a,
    // 0x0003 VALUE-ORG_BLUETOOTH_CHARACTERISTIC_BATTERY_LEVEL-DYNAMIC | READ | NOTIFY-''
    // READ_ANYBODY
    0x08, 0x00, 0x02, 0x01, 0x03, 0x00, 0x19, 0x2a,
    // 0x0004 CLIENT_CHARACTERISTIC_CONFIGURATION
    // READ_ANYBODY, WRITE_ANYBODY
    0x0a, 0x00, 0x0a, 0x01, 0x04, 0x00, 0x02, 0x29, 0x00, 0x00,
#if GFPS_EN
    // 0x0001 PRIMARY_SERVICE-FE2C
    0x0a, 0x00, 0x02, 0x00, 0x21, 0x00, 0x00, 0x28, 0x2c, 0xfe,

    // 0x0002 CHARACTERISTIC-FE2C1233-8366-4814-8EB0-01DE32100BEA-READ | DYNAMIC
    0x1b, 0x00, 0x02, 0x00, 0x22, 0x00, 0x03, 0x28, 0x02, 0x23, 0x00, 0xea, 0x0b, 0x10, 0x32, 0xde, 0x01, 0xb0, 0x8e, 0x14, 0x48, 0x66, 0x83, 0x33, 0x12, 0x2c, 0xfe,
    // 0x0003 VALUE-FE2C1233-8366-4814-8EB0-01DE32100BEA-READ | DYNAMIC-''
    // READ_ANYBODY
    0x16, 0x00, 0x02, 0x03, 0x23, 0x00, 0xea, 0x0b, 0x10, 0x32, 0xde, 0x01, 0xb0, 0x8e, 0x14, 0x48, 0x66, 0x83, 0x33, 0x12, 0x2c, 0xfe,

    // 0x0004 CHARACTERISTIC-FE2C1234-8366-4814-8EB0-01DE32100BEA-WRITE | NOTIFY | DYNAMIC
    0x1b, 0x00, 0x02, 0x00, 0x24, 0x00, 0x03, 0x28, 0x18, 0x25, 0x00, 0xea, 0x0b, 0x10, 0x32, 0xde, 0x01, 0xb0, 0x8e, 0x14, 0x48, 0x66, 0x83, 0x34, 0x12, 0x2c, 0xfe,
    // 0x0005 VALUE-FE2C1234-8366-4814-8EB0-01DE32100BEA-WRITE | NOTIFY | DYNAMIC-''
    // WRITE_ANYBODY
    0x16, 0x00, 0x08, 0x03, 0x25, 0x00, 0xea, 0x0b, 0x10, 0x32, 0xde, 0x01, 0xb0, 0x8e, 0x14, 0x48, 0x66, 0x83, 0x34, 0x12, 0x2c, 0xfe,
    // 0x0006 CLIENT_CHARACTERISTIC_CONFIGURATION
    // READ_ANYBODY, WRITE_ANYBODY
    0x0a, 0x00, 0x0a, 0x01, 0x26, 0x00, 0x02, 0x29, 0x00, 0x00,

    // 0x0007 CHARACTERISTIC-FE2C1235-8366-4814-8EB0-01DE32100BEA-WRITE | NOTIFY | DYNAMIC
    0x1b, 0x00, 0x02, 0x00, 0x27, 0x00, 0x03, 0x28, 0x18, 0x28, 0x00, 0xea, 0x0b, 0x10, 0x32, 0xde, 0x01, 0xb0, 0x8e, 0x14, 0x48, 0x66, 0x83, 0x35, 0x12, 0x2c, 0xfe,
    // 0x0008 VALUE-FE2C1235-8366-4814-8EB0-01DE32100BEA-WRITE | NOTIFY | DYNAMIC-''
    // WRITE_ANYBODY
    0x16, 0x00, 0x08, 0x03, 0x28, 0x00, 0xea, 0x0b, 0x10, 0x32, 0xde, 0x01, 0xb0, 0x8e, 0x14, 0x48, 0x66, 0x83, 0x35, 0x12, 0x2c, 0xfe,
    // 0x0009 CLIENT_CHARACTERISTIC_CONFIGURATION
    // READ_ANYBODY, WRITE_ANYBODY
    0x0a, 0x00, 0x0a, 0x01, 0x29, 0x00, 0x02, 0x29, 0x00, 0x00,

    // 0x000a CHARACTERISTIC-FE2C1236-8366-4814-8EB0-01DE32100BEA-WRITE | DYNAMIC
    0x1b, 0x00, 0x02, 0x00, 0x2a, 0x00, 0x03, 0x28, 0x08, 0x2b, 0x00, 0xea, 0x0b, 0x10, 0x32, 0xde, 0x01, 0xb0, 0x8e, 0x14, 0x48, 0x66, 0x83, 0x36, 0x12, 0x2c, 0xfe,
    // 0x000b VALUE-FE2C1236-8366-4814-8EB0-01DE32100BEA-WRITE | DYNAMIC-''
    // WRITE_ANYBODY
    0x16, 0x00, 0x08, 0x03, 0x2b, 0x00, 0xea, 0x0b, 0x10, 0x32, 0xde, 0x01, 0xb0, 0x8e, 0x14, 0x48, 0x66, 0x83, 0x36, 0x12, 0x2c, 0xfe,

#if 0 // 后续完善Personalized Name
    // 0x000c CHARACTERISTIC-FE2C1237-8366-4814-8EB0-01DE32100BEA-WRITE | NOTIFY | DYNAMIC
    0x1b, 0x00, 0x02, 0x00, 0x2c, 0x00, 0x03, 0x28, 0x18, 0x2d, 0x00, 0xea, 0x0b, 0x10, 0x32, 0xde, 0x01, 0xb0, 0x8e, 0x14, 0x48, 0x66, 0x83, 0x37, 0x12, 0x2c, 0xfe,
    // 0x000d VALUE-FE2C1237-8366-4814-8EB0-01DE32100BEA-WRITE | NOTIFY | DYNAMIC-''
    // WRITE_ANYBODY
    0x16, 0x00, 0x08, 0x03, 0x2d, 0x00, 0xea, 0x0b, 0x10, 0x32, 0xde, 0x01, 0xb0, 0x8e, 0x14, 0x48, 0x66, 0x83, 0x37, 0x12, 0x2c, 0xfe,
    // 0x000e CLIENT_CHARACTERISTIC_CONFIGURATION
    // READ_ANYBODY, WRITE_ANYBODY
    0x0a, 0x00, 0x0a, 0x01, 0x2e, 0x00, 0x02, 0x29, 0x00, 0x00,
#endif

#if ENABLE_FIRMWARE_REVISION
    // 0x000f PRIMARY_SERVICE-280A
    0x0a, 0x00, 0x02, 0x00, 0x1f, 0x00, 0x00, 0x28, 0x0a, 0x28,
    // 0x0010 CHARACTERISTIC-2A26-READ | DYNAMIC
    0x0d, 0x00, 0x02, 0x00, 0x20, 0x00, 0x03, 0x28, 0x02, 0x21, 0x00, 0x26, 0x2a,
    // 0x0011 VALUE-2A26-READ | DYNAMIC-''
    // READ_ANYBODY
    0x08, 0x00, 0x02, 0x01, 0x21, 0x00, 0x26, 0x2a,
#endif // ENABLE_FIRMWARE_REVISION
#endif // GFPS_EN

 	// END
    0x00, 0x00,
}; // total size 99 bytes

const u8 *ble_get_profile_data(void)
{
    //printf("%s\n",__func__);
    return profile_data;
}

// ---------------------------------------------------------------------------
const uint8_t adv_data_const[] = {
    // Flags general discoverable, BR/EDR not supported
    0x02, 0x01, 0x02,
    // Manufacturer Specific Data
    0x03, 0xff, 0x42, 0x06,
    // GFPS, Tx Power, -20dBm
    0x02, 0x0A, 0xEC,
};

const uint8_t scan_data_const[] = {
    // Name
    0x08, 0x09, 'B', 'L', 'E', '-', 'B', 'O', 'X',
};

u32 ble_get_scan_data(u8 *scan_buf, u32 buf_size)
{
    memset(scan_buf, 0, buf_size);
    u32 data_len = sizeof(scan_data_const);
    memcpy(scan_buf, scan_data_const, data_len);

    //读取BLE配置的蓝牙名称
    int len;
    len = strlen(xcfg_cb.le_name);
    if (len > 0) {
        memcpy(&scan_buf[2], xcfg_cb.le_name, len);
        data_len = 2 + len;
        scan_buf[0] = len + 1;
    }
    return data_len;
}

u32 ble_get_adv_data(u8 *adv_buf, u32 buf_size)
{
    memset(adv_buf, 0, buf_size);
    u32 data_len = sizeof(adv_data_const);
    memcpy(adv_buf, adv_data_const, data_len);
    return data_len;
}

///////////////////////////////////////////////////////////////////////////
#define MAX_NOTIFY_NUM          8
#define MAX_NOTIFY_LEN          256     //max=256
#define NOTIFY_POOL_SIZE       (MAX_NOTIFY_LEN + sizeof(struct txbuf_tag)) * MAX_NOTIFY_NUM

AT(.ble_cache.att)
uint8_t notify_tx_pool[NOTIFY_POOL_SIZE];

void ble_txpkt_init(void)
{
    txpkt_init(&notify_tx, notify_tx_pool, MAX_NOTIFY_NUM, MAX_NOTIFY_LEN);
    notify_tx.send_kick = ble_send_kick;
}

void bsp_ble_process(void)
{
}

//----------------------------------------------------------------------------
//
void ble_app_init(void)
{
    ble_gatts_init();
}

#endif

