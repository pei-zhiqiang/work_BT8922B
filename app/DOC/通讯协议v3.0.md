# 通讯协议

## 角色定义

**蓝牙通讯下**

主机：手机端

从机：BT8922蓝牙耳机端

**串口通讯下**

主机：BT8922

从机：BT8829C

# 蓝牙通讯协议

## 写入 主机-->从机

```
           /-----------/-----------/------------/------------/------------/------------/-----------/
         /    帧头    /   功能码   / 寄存器地址  /   数据长度  /   变长数据 /  CRC16_L   /  CRC16_H  /
       /------------/------------/------------/------------/------------/------------/-----------/
     /   2Bytes   /    1Byte   /   2Bytes   /   2Bytes   /     ...    /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/-------------/
 /**************C******************R*******************C**********/
PS：
小端模式：低8位在前
帧长最小为：10Bytes
总帧长为：9Bytes + 数据长度
```



### 回复写入 从机-->主机

```
           /------------/------------/------------/------------/
         /    帧头    /   功能码    /  寄存器地址 / ACK RESULT /
       /------------/------------/------------/------------/
     /   2Bytes   /    1Byte   /    2Byte   /   1Bytes   /
   /------------/------------/------------/------------/
PS：
帧长固定为：6Bytes 
ACK RESULT：1Byte 16进制0x01
```

## 读取 主机-->从机

```
           /------------/-----------/------------/------------/------------/
         /    帧头    /   功能码   / 寄存器地址  /  CRC16_L   /   CRC16_H  /
       /------------/------------/------------/------------/------------/
     /   2Bytes   / 1Byte 0x04 /   2Bytes   /   1Byte    /    1Byte   /
   /------------/------------/------------/------------/------------/
 /******C************R************C******/ 
PS：
小端模式：低8位在前
帧长固定为：7Bytes
```

### 回复读取 从机-->主机

```
           /------------/------------/------------/------------/------------/------------/------------/
         /    帧头    /   功能码    /  寄存器地址 /  数据长度  /   变长数据  /  CRC16_L   /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   /    2Byte   /   2Bytes   /     ...    /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/
 /*************C******************R*******************C***********/
PS：
小端模式：低8位在前
帧长最短为：10Bytes
总帧长为：9Bytes + 数据长度
```

| 字段         | 数值                  | 描述                 |
| ---------- | ------------------- | ------------------ |
| 帧头         | 0x7A 0x55/0x75 0xAA | 代表由主机发/代表从机回复      |
| 数据长度       | 可变                  | ==依附0x03功能码存在==    |
| 变长数据       | 可变                  | ==依附0x03功能码存在==    |
| ACK RESULT | 0x01                | 为1时设置下发数据正常，其他操作失败 |

| 功能码  | 描述   |
| ---- | ---- |
| 0x03 | 设置参数 |
| 0x04 | 请求参数 |

| 寄存器地址（16进制）   | 描述                      | 可写或可读数值     | 数值范围                                                     | 字节数             | 读写权限 | 更新版本 |
| ---------------------- | ------------------------- | ------------------ | ------------------------------------------------------------ | ------------------ | -------- | -------- |
| 0x0055                 | 音量控制                  | int8               | 设置：左耳：01，右耳：02，格式：左耳/右耳+ 数值；数值范围：-7 - 7，默认为0<br/> 读取：返回2个字节，分别代表左耳和右耳 | W：2Byte；R：2Byte | RW       | V2.0     |
| 0x0155                 | 降噪级别                  | int8[1] + int16[2] | 数值：level + Smooth_eta + Smooth_eta_min：数值范围level：1 ~ 15（推荐值不超过8），Smooth_eta：1 ~ 1000，Smooth_eta_min：1 ~ 1000，Smooth_eta_min要小于Smooth_eta | W：3Byte；R：3Byte | RW       | V2.6     |
| 0x4255                 | 静音                      | int8               | 控制命令：0x55                                               | 1Byte              | W        | V2.0     |
| 0x4355                 | 恢复声音                  | int8               | 控制命令：0x55                                               | 1Byte              | W        | V2.0     |
| 0x4655                 | 音频EQ:31Hz               | int8               | 增大增益数值范围：0x01 - 0x12，减小增益设置范围：0x21 - 0x32， 默认值0，不调整 | 1Byte              | W        | V2.0     |
| 0x4755                 | 音频EQ:63Hz               | int8               | 增大增益数值范围：0x01 - 0x12，减小增益设置范围：0x21 - 0x32， 默认值0，不调整 | 1Byte              | W        | V2.0     |
| 0x4855                 | 音频EQ:160Hz              | int8               | 增大增益数值范围：0x01 - 0x12，减小增益设置范围：0x21 - 0x32， 默认值0，不调整 | 1Byte              | W        | V2.0     |
| 0x4955                 | 音频EQ:300Hz              | int8               | 增大增益数值范围：0x01 - 0x12，减小增益设置范围：0x21 - 0x32， 默认值0，不调整 | 1Byte              | W        | V2.0     |
| 0x5055                 | 音频EQ:400Hz              | int8               | 增大增益数值范围：0x01 - 0x12，减小增益设置范围：0x21 - 0x32， 默认值0，不调整 | 1Byte              | W        | V2.0     |
| 0x5155                 | 音频EQ:1000Hz             | int8               | 增大增益数值范围：0x01 - 0x12，减小增益设置范围：0x21 - 0x32， 默认值0，不调整 | 1Byte              | W        | V2.0     |
| 0x5255                 | 音频EQ:3000Hz             | int8               | 增大增益数值范围：0x01 - 0x12，减小增益设置范围：0x21 - 0x32， 默认值0，不调整 | 1Byte              | W        | V2.0     |
| 0x5355                 | 音频EQ:4000Hz             | int8               | 增大增益数值范围：0x01 - 0x12，减小增益设置范围：0x21 - 0x32， 默认值0，不调整 | 1Byte              | W        | V2.0     |
| 0x5455                 | 音频EQ:8000Hz             | int8               | 增大增益数值范围：0x01 - 0x12，减小增益设置范围：0x21 - 0x32， 默认值0，不调整 | 1Byte              | W        | V2.0     |
| 0x5555                 | 音频EQ:16000Hz            | int8               | 增大增益数值范围：0x01 - 0x12，减小增益设置范围：0x21 - 0x32， 默认值0，不调整 | 1Byte              | W        | V2.0     |
| 0x5655                 | 获取所有音频EQ增益值      | int8[10]           | 所有音频流EQ增益值（寄存器：0x4655 - 0x5555）                | 读取10Bytes        | R        | V2.0     |
| 0x5755                 | 250Hz,纯音音频发声        | int8               | 数值范围：0-100    对应的音频的dB值；左耳：01，右耳：02，格式：左耳/右耳+数值 | 2Byte              | W        | V2.0     |
| 0x5855                 | 500Hz,纯音音频发声        | int8               | 数值范围：0-100    对应的音频的dB值；左耳：01，右耳：02，格式：左耳/右耳+数值 | 2Byte              | W        | V2.0     |
| 0x5955                 | 1000Hz,纯音音频发声       | int8               | 数值范围：0-100    对应的音频的dB值；左耳：01，右耳：02，格式：左耳/右耳+数值 | 2Byte              | W        | V2.0     |
| 0x6055                 | 2000Hz,纯音音频发声       | int8               | 数值范围：0-100    对应的音频的dB值；左耳：01，右耳：02，格式：左耳/右耳+数值 | 2Byte              | W        | V2.0     |
| 0x6155                 | 4000Hz,纯音音频发声       | int8               | 数值范围：0-100    对应的音频的dB值；左耳：01，右耳：02，格式：左耳/右耳+数值 | 2Byte              | W        | V2.0     |
| 0x6255                 | 8000Hz,纯音音频发声       | int8               | 数值范围：0-100    对应的音频的dB值；左耳：01，右耳：02，格式：左耳/右耳+数值 | 2Byte              | W        | V2.0     |
| 0x6355                 | 纯音音频停止发声          | int8               | 数值：01                                                     | 1Byte              | W        | V2.0     |
| 0x6455                 | 功能选择（仅测试使用）    | int8               | 数值范围：0x00-0x10；0x00：Beamforming波束形成功能，0x01：降噪功能；0x02：暂无，0x03：EQ调节，0x04：宽动态控制，0x05：音量控制，0x06：自动增益，0x07：算法全开，0x08：原生输出，0x09：测听输出，0x10：静音输出， 0x11：FIR，0x12:自主测听校准模式；0x13:HHT盒式助听模式 | 1byte              | WR       | v2.9     |
| 0x6555                 | WDRC                      | int8[31]           | 左耳：01，右耳：02，格式：左耳/右耳+ 数值；数值：L_gain[5] + H_gain[5] + mute[5] + amp[5] + cmp[5] + limit[5]；[5]依次代表五个频带：250Hz，750Hz，1500Hz，3000Hz，5000Hz；数值范围：L_gain​：0-50；H_gain​：0\~50；mute:0\~60，amp：1\~100；cmp：2\~119；limit：3~120； | 31Byte             | W        | V2.0     |
| 0x6655                 | EQ                        | int8[6]            | 左耳：01，右耳：02，格式：左耳/右耳+ 数值；数值：EQ[5]；[5]依次代表五个频带：250Hz，750Hz，1500Hz，3000Hz，5000Hz；每个EQ数值范围：增益0x01~0x30，减益0x31~0x60(对应-1 ~ -30)，0x00：不做变化； | 6Byte              | WR       | V2.0     |
| 0x6755                 | AGC                       | int8[3]            | 数值：UP_dB + DOWN_dB；数值范围：UP_dB：90\~110；DOWN_dB：1~10 | 3byte              | WR       | V2.0     |
| 0x6855                 | WDRC获取                  | int8[60]           | 数值：左耳L_gain[5] + H_gain[5] + mute[5] + amp[5] + cmp[5] + limit[5] + 右耳L_gain[5] + H_gain[5] + mute[5] + amp[5] + cmp[5] + limit[5] ；[5]依次代表五个频带：250Hz，750Hz，1500Hz，3000Hz，5000Hz；数值范围：L_gain：0-50；H_gain：0\~50；mute:0\~60，amp：1\~100；cmp：2\~119；limit：3~120； | 60Byte             | R        | v2.0     |
| 0x6955                 | EQ获取                    | int8[10]           | 数值：左耳EQ[5] + 右耳EQ[5]；[5]依次代表五个频带：250Hz，750Hz，1500Hz，3000Hz，5000Hz；每个EQ数值范围：增益0x01~0x30，减益0x31~0x60(对应-1 ~ -30)，0x00：不做变化； | 10byte             | R        | V2.0     |
| 0x7055                 | AGC获取                   | int8[4]            | 数值：UP_dB + DOWN_dB；数值范围：UP_dB：90~110；DOWN_dB：1~10 | 4byte              | R        | V2.0     |
| 0x7155                 | 设置MIC灵敏度             | int8               | 数值范围：0x00 ~ 0x60，对应0~-60                             | 1byte              | RW       | v2.0     |
| 0x7255                 | 设置测听Speaker补偿参数   | int8[3]            | 数值：频率+Set_dB+Out_dB；频率：01~06，对应250Hz，500Hz，1000Hz，2000Hz，4000Hz，8000Hz；Set_dB：1 ~ 50，Out_dB：0 ~ 120，diff_db范围：-37 ~ 50 | 3Byte              | WR       | V2.7     |
| 0x7355                 | 重置所有算法参数          | int8               | 数值：00                                                     | 1Byte              | W        | V2.1     |
| 0x7455                 | 调节平滑系数              | int16[10]          | 数值：WDRC[5] + EQ[5]，数值范围：；int16低位在前，高位在后   | 20Byte             | RW       | V2.1     |
| 0x7555                 | 调节FIR系数               | int16[n]           | 数值：FIR[n],n为不定长，数值范围：0 ~ 65535,  0 ~ 32767（对应0~ 32767），  32768 ~ 65535（对应-1 ~ -32768），低位在前，高位在后 | 不定长度           | RW       | V2.1     |
| 0x7655                 | 设置算法使能              | int8[6]            | 数值：设置状态[6]；数值范围：依次对应EQ,WDRC,VOL,AGC,FIR,NS，设置状态：00：禁用，01：开启 | 6Byte              | RW       | V2.2     |
| 0x7755                 | 设置校准时间              | int8               | 数值:时间（单位：秒），范围：3 ~ 60                          | 1Byte              | W        | V2.3     |
| 0x7855                 | AGC自动增益（类时域WDRC） | int8[7] + int16[1] | 数值：mute + amp + cmp + limit + l_gain + h_gain + atk + rsl，数值范围：L_gain：0-50；H_gain：0\~50；mute:0\~60，amp：1\~100；cmp：2\~119；limit：3~120；atk：0 - 200；rsl：0 - 1000；int16低位在前，高位在后 | 9Byte              | RW       | V2.4     |
| 0x7955                 | 设置前置音量等级          | int8               | 格式：数值；数值范围：0 - 14，默认0；8 ~ 14 代表 -1 ~ -7     | W：1Byte；R：1Byte | RW       | V2.5     |
| 0x8055                 | 设置模式参数              | int8[12]+int16[1]  | 格式：左音量+右音量+降噪（level + Smooth_eta + Smooth_eta_min）+AGC自动增益（类时域WDRC:mute + amp + cmp + limit + l_gain + h_gain + atk + rsl）；数值范围参考各参数的范围 | W：14Byte          | W        | V2.8     |
| 0x8155                 | 电量获取                  | int8               | 数值范围：1 ~ 100                                            | 1Byte              | R        | V2.9     |
| 0x8156                 | 重置HHT配对               | int8               | 数值1，触发重新配对，**注意该项功能仅支持在HHT模式下使用！，非HHT模式将返回重置失败** | 1Byte              | W        | V3.0     |
| 0x8829（双芯片间通讯） | 关机使能                  | int8               | 默认为0，使能时为1，进行关机                                 | 1Byte              | W        | V3.0     |
| 0x8830（双芯片间通讯） | 进入低功耗                | int8               | 数值0，退出低功耗，数值1，进入低功耗                         | 1Byet              | W        | V3.0     |
| 0x8831（双芯片间通讯） | 音量控制                  | int8               | 数值范围：0 - 7级                                            | 1Byte              | RW       | V3.0     |
| 0x8832（双芯片间通讯） | HHT状态                   | int16              | （设备在开机后每间隔1s发送一条指令告知主机，当前状态）<br/>bit0：1为待机状态 <br/>bit1：1为DAC开启状态 <br/>bit2：1为蓝牙开启状态<br/>bit3：1为已与HHT盒子配对成功<br/>bit4 - bit7：报告当前电量 1 - 10Level<br/>bit8 - bit11：报告当前音量等级 0 - 7 | 1Byte              | R        | V3.0     |
| 0x8833（双芯片间通讯） | 重置HHT配对               | int8               | 数值1，触发重新配对                                          | 1Byte              | W        | V3.0     |
| 0xFF00                 | 产品软件版本              | int16              | 数值范围：0x0011 - 0xFFFF ，数值含义：VER_MAJOR + VER_MINOR + VER_REVISION，VER_MAJOR 占用高字节，VER_MINOR 占用低字节的的高4位，VER_REVISION占用低字节的低4位， **如0x0011表示：VER_MAJOR 为0，VER_MINOR 为1，VER_REVISION为1合并起来就是v0.1.1**，当前默认：0x0011 | 2Bytes             | R        | V2.0     |
| 0xFF01                 | 产品硬件版本              | int16              | 数值范围：0x0011 - 0xFFFF ，数值含义：VER_MAJOR + VER_MINOR + VER_REVISION，VER_MAJOR 占用高字节，VER_MINOR 占用低字节的的高4位，VER_REVISION占用低字节的低4位， **如0x0011表示：VER_MAJOR 为0，VER_MINOR 为1，VER_REVISION为1合并起来就是v0.1.1**，当前默认：0x0011 | 2Bytes             | R        | V2.0     |
| 0xFF02                 | 产品系列号                | int16              | 数值范围：0x0000 - 0xFFFF，此参数用作产品系列标识，当前默认：0xFFFF | 2Bytes             | R        | V2.0     |

## 测试报文

### 读取软件版本信息

```bash
 #主机发送读取命令
【发送】7A 55 04 00 FF ED 87
【接收】75 AA 04 00 FF 02 00 11 00 DB E5
```



## 示例代码

[通讯协议](Protocol_Stack_Demo/README.md)

## CRC计算公式

```c
/**
 * @brief modbus CRC计算
 * 
 * @param Data 
 * @param GenPoly 多项式
 * @param CrcData 
 * @return uint16_t 
 */
static uint16_t modbus_crc_cal(uint16_t Data ,uint16_t GenPoly ,uint16_t CrcData)
{
	uint16_t TmpI;
	Data *= 2;
	for(TmpI = 8; TmpI > 0; TmpI--) 
  {
		Data = Data / 2;
		if ((Data ^ CrcData) & 1)
			CrcData = (CrcData / 2) ^ GenPoly;
		else
			CrcData /= 2;
	}
	return CrcData;
}

/**
 * @brief modbusCRC计算
 * 
 * @param data 带入CRC计算的数据起始
 * @param data_len 带入CRC计算的数据长度
 * @return uint16_t 
 */
uint16_t modbus_crc_return(uint8_t *data, uint16_t data_len)
{
	uint16_t temp;
	uint16_t crc_ret = 0xFFFF;
	for (temp = 0; temp < data_len; temp++)
	{
		crc_ret = modbus_crc_cal(data[temp], 0xA001, crc_ret);
	}
	return crc_ret;
}
```

